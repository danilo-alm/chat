services:
  
  gateway:
    image: daniloalm/chat-gateway
    environment:
      USER_SERVICE_URL: ${USER_SERVICE_URL:-user-service:50051}
      AUTH_SERVICE_URL: ${AUTH_SERVICE_URL:-auth-service:50051}
      LAST_SEEN_SERVICE_URL: ${LAST_SEEN_SERVICE_URL:-last-seen-service:50051}
    depends_on:
      - user-service
      - auth-service
      - last-seen-service

  user-service:
    image: daniloalm/chat-user-service
    environment:
      MONGO_URI: mongodb://root:secret@user-db:27017
      GRPC_PORT: 50051
    depends_on:
      - user-db

  user-db:
    image: mongo:8.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: secret
    volumes:
      - user_data:/data/db

  auth-service:
    image: daniloalm/chat-auth-service
    environment:
      MARIADB_URI: user:secret@tcp(auth-db:3306)/authdb
      USER_SERVICE_URL: ${USER_SERVICE_URL:-user-service:50051}
      ACCESS_TOKEN_SECRET: "${ACCESS_TOKEN_SECRET}"
      REFRESH_TOKEN_SECRET: "${REFRESH_TOKEN_SECRET}"
      GRPC_PORT: 50051
    depends_on:
      auth-db:
        condition: service_healthy
      user-service:
        condition: service_started

  auth-db:
    image: mariadb:lts
    environment:
      - MARIADB_USER=user
      - MARIADB_PASSWORD=secret
      - MARIADB_ROOT_PASSWORD=root
      - MARIADB_DATABASE=authdb
    volumes:
      - auth_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      start_period: 3s
      interval: 3s
      timeout: 5s
      retries: 3
    
  last-seen-service:
    image: daniloalm/chat-last-seen-service
    environment:
      MONGO_URI: mongodb://root:secret@last-seen-db:27017
      GRPC_PORT: 50051
    depends_on:
      - last-seen-db

  last-seen-db:
    image: mongo:8.0
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: secret
    volumes:
      - last_seen_data:/data/db
  
  nginx:
    image: nginx:1.29-alpine
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - auth-service
      - user-service
      - last-seen-service

volumes:
  last_seen_data:
  auth_data:
  user_data:
